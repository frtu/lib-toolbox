#!/bin/bash
set -e
export PGPASSWORD=$POSTGRES_PASSWORD;

psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
  CREATE USER ${APP_DB_USER}_admin  WITH PASSWORD '${APP_DB_PASS}';
  CREATE USER ${APP_DB_USER}_rw     WITH PASSWORD '${APP_DB_PASS}';
  CREATE USER ${APP_DB_USER}_r      WITH PASSWORD '${APP_DB_PASS}';

  CREATE            DATABASE ${APP_DB_NAME} encoding 'UTF8';
  ALTER             DATABASE ${APP_DB_NAME} OWNER TO ${APP_DB_USER}_admin;
  GRANT CREATE ON   DATABASE ${APP_DB_NAME} TO ${APP_DB_USER}_admin;

  \connect ${APP_DB_NAME} ${POSTGRES_USER};

  CREATE EXTENSION IF NOT EXISTS "hstore";
  CREATE EXTENSION IF NOT EXISTS "pg_trgm";
  CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
  CREATE EXTENSION IF NOT EXISTS "pgcrypto";
  CREATE EXTENSION IF NOT EXISTS "pg_stat_statements";

  CREATE SCHEMA IF NOT EXISTS ${APP_DB_SCHEMA};
  
  GRANT ALL PRIVILEGES    ON DATABASE ${APP_DB_NAME}      TO ${APP_DB_USER}_admin;
  GRANT ALL PRIVILEGES    ON SCHEMA ${APP_DB_SCHEMA}      TO ${APP_DB_USER}_admin;
  GRANT ALL PRIVILEGES    ON ALL TABLES                   IN SCHEMA ${APP_DB_SCHEMA} TO ${APP_DB_USER}_admin;
  GRANT USAGE, SELECT     ON ALL SEQUENCES                IN SCHEMA ${APP_DB_SCHEMA} TO ${APP_DB_USER}_admin;
  GRANT EXECUTE           ON ALL FUNCTIONS                IN SCHEMA ${APP_DB_SCHEMA} TO ${APP_DB_USER}_admin;
  ALTER DEFAULT PRIVILEGES FOR USER ${POSTGRES_USER}      IN SCHEMA ${APP_DB_SCHEMA} GRANT ALL PRIVILEGES ON TABLES TO ${APP_DB_USER}_admin;
  ALTER DEFAULT PRIVILEGES FOR USER ${APP_DB_USER}_admin  IN SCHEMA ${APP_DB_SCHEMA} GRANT ALL PRIVILEGES ON TABLES TO ${APP_DB_USER}_admin;

  GRANT ALL PRIVILEGES    ON ALL TABLES                   IN SCHEMA ${APP_DB_SCHEMA} TO ${APP_DB_USER}_rw;
  GRANT USAGE, SELECT     ON ALL SEQUENCES                IN SCHEMA ${APP_DB_SCHEMA} TO ${APP_DB_USER}_rw;
  ALTER DEFAULT PRIVILEGES FOR USER ${POSTGRES_USER}      IN SCHEMA ${APP_DB_SCHEMA} GRANT ALL PRIVILEGES ON TABLES TO ${APP_DB_USER}_rw;

  GRANT SELECT            ON ALL TABLES                   IN SCHEMA ${APP_DB_SCHEMA} TO ${APP_DB_USER}_r;
  ALTER DEFAULT PRIVILEGES FOR USER ${POSTGRES_USER}      IN SCHEMA ${APP_DB_SCHEMA} GRANT SELECT ON TABLES TO ${APP_DB_USER}_r;

  \connect ${APP_DB_NAME} ${APP_DB_USER}_admin;

  ALTER DEFAULT PRIVILEGES FOR USER ${APP_DB_USER}_admin  IN SCHEMA ${APP_DB_SCHEMA} GRANT ALL PRIVILEGES ON TABLES TO ${APP_DB_USER}_admin;
  ALTER DEFAULT PRIVILEGES FOR USER ${APP_DB_USER}_admin  IN SCHEMA ${APP_DB_SCHEMA} GRANT ALL PRIVILEGES ON TABLES TO ${APP_DB_USER}_rw;
  ALTER DEFAULT PRIVILEGES FOR USER ${APP_DB_USER}_admin  IN SCHEMA ${APP_DB_SCHEMA} GRANT SELECT ON TABLES TO ${APP_DB_USER}_r;

  GRANT USAGE, SELECT ON ALL SEQUENCES                    IN SCHEMA ${APP_DB_SCHEMA} TO ${APP_DB_USER}_rw;
  ALTER DEFAULT PRIVILEGES FOR USER ${APP_DB_USER}_admin  IN SCHEMA ${APP_DB_SCHEMA} GRANT SELECT ON TABLES TO ${APP_DB_USER}_r;
  ALTER DEFAULT PRIVILEGES FOR USER ${APP_DB_USER}_admin  IN SCHEMA ${APP_DB_SCHEMA} GRANT USAGE, SELECT ON SEQUENCES TO ${APP_DB_USER}_rw;
  ALTER DEFAULT PRIVILEGES FOR USER ${APP_DB_USER}_admin  IN SCHEMA ${APP_DB_SCHEMA} GRANT ALL PRIVILEGES ON TABLES TO ${APP_DB_USER}_rw;

  GRANT ALL PRIVILEGES ON all TABLES                      IN SCHEMA ${APP_DB_SCHEMA} TO ${POSTGRES_USER};
  GRANT USAGE, SELECT ON ALL SEQUENCES                    IN SCHEMA ${APP_DB_SCHEMA} TO ${POSTGRES_USER};
  ALTER DEFAULT PRIVILEGES                                IN SCHEMA ${APP_DB_SCHEMA} GRANT ALL PRIVILEGES ON TABLES TO ${POSTGRES_USER};

  GRANT SELECT ON ALL TABLES                              IN SCHEMA ${APP_DB_SCHEMA} TO ${APP_DB_USER}_r;
  ALTER DEFAULT PRIVILEGES                                IN SCHEMA ${APP_DB_SCHEMA} GRANT SELECT ON TABLES TO ${APP_DB_USER}_r;

  BEGIN;

  COMMIT;
EOSQL